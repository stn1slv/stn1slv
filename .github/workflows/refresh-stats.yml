name: Refresh statistics
on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 5 * *'   # Run on the 5st of every month at midnight UTC
    - cron: '0 0 15 * *'  # Run on the 15th of every month at midnight UTC
    - cron: '0 0 25 * *'  # Run on the 25st of every month at midnight UTC
  workflow_dispatch:
permissions:
  contents: write
jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Init repo
        run: |
          git config --global user.name 'stn1slv'
          git config --global user.email 'stn1slv@users.noreply.github.com'
          git pull origin main
      - name: Update GitHub Stats
        continue-on-error: true
        run: |
            if wget -O img/github-stats-dark.svg "https://github-readme-stats.vercel.app/api?username=stn1slv&show_icons=true&hide_border=true&locale=en&count_private=true&include_all_commits=true&hide_title=true&theme=vue-dark"; then
              # Check file size and revert if too small
              if [ $(stat -c%s img/github-stats-dark.svg 2>/dev/null || stat -f%z img/github-stats-dark.svg) -lt 2500 ]; then
                echo "github-stats-dark.svg is too small, reverting changes..."
                git checkout HEAD -- img/github-stats-dark.svg 2>/dev/null || rm -f img/github-stats-dark.svg
              fi
            else
              echo "Failed to download github-stats-dark.svg, removing file..."
              git checkout HEAD -- img/github-stats-dark.svg 2>/dev/null || rm -f img/github-stats-dark.svg
            fi
            
            if wget -O img/github-stats-light.svg "https://github-readme-stats.vercel.app/api?username=stn1slv&show_icons=true&hide_border=true&locale=en&count_private=true&include_all_commits=true&hide_title=true&theme=vue"; then
              # Check file size and revert if too small
              if [ $(stat -c%s img/github-stats-light.svg 2>/dev/null || stat -f%z img/github-stats-light.svg) -lt 2500 ]; then
                echo "github-stats-light.svg is too small, reverting changes..."
                git checkout HEAD -- img/github-stats-light.svg 2>/dev/null || rm -f img/github-stats-light.svg
              fi
            else
              echo "Failed to download github-stats-light.svg, removing file..."
              git checkout HEAD -- img/github-stats-light.svg 2>/dev/null || rm -f img/github-stats-light.svg
            fi
            
            if wget -O img/github-stats.svg "https://github-readme-stats.vercel.app/api?username=stn1slv&show_icons=true"; then
              # Check file size and revert if too small
              if [ $(stat -c%s img/github-stats.svg 2>/dev/null || stat -f%z img/github-stats.svg) -lt 2500 ]; then
                echo "github-stats.svg is too small, reverting changes..."
                git checkout HEAD -- img/github-stats.svg 2>/dev/null || rm -f img/github-stats.svg
              fi
            else
              echo "Failed to download github-stats.svg, removing file..."
              git checkout HEAD -- img/github-stats.svg 2>/dev/null || rm -f img/github-stats.svg
            fi
      # - name: Update GitHub Streak Stats
      #   continue-on-error: true
      #   run: |
      #       wget -O img/streak-stats-dark.svg "https://streak-stats.demolab.com/?user=stn1slv&theme=gotham&mode=weekly&card_width=400&hide_border=true"
      #       wget -O img/streak-stats-light.svg "https://streak-stats.demolab.com/?user=stn1slv&theme=vue&mode=weekly&card_width=400&hide_border=true"
      #       wget -O img/streak-stats.svg "https://streak-stats.demolab.com/?user=stn1slv&mode=weekly&card_width=400"
      - name: Update Most used languages
        continue-on-error: true
        run: |
                if wget -O img/top-langs-dark.svg "https://github-readme-stats.vercel.app/api/top-langs?username=stn1slv&show_icons=true&locale=en&layout=compact&hide=markdown,xml,asciidoc,html,handlebars&langs_count=8&no-bg=true&hide_border=true&theme=vue-dark"; then
                  # Check file size and revert if too small
                  if [ $(stat -c%s img/top-langs-dark.svg 2>/dev/null || stat -f%z img/top-langs-dark.svg) -lt 2500 ]; then
                    echo "top-langs-dark.svg is too small, reverting changes..."
                    git checkout HEAD -- img/top-langs-dark.svg 2>/dev/null || rm -f img/top-langs-dark.svg
                  fi
                else
                  echo "Failed to download top-langs-dark.svg, removing file..."
                  git checkout HEAD -- img/top-langs-dark.svg 2>/dev/null || rm -f img/top-langs-dark.svg
                fi
                
                if wget -O img/top-langs-light.svg "https://github-readme-stats.vercel.app/api/top-langs?username=stn1slv&show_icons=true&locale=en&layout=compact&hide=markdown,xml,asciidoc,html,handlebars&langs_count=8&no-bg=true&theme=vue"; then
                  # Check file size and revert if too small
                  if [ $(stat -c%s img/top-langs-light.svg 2>/dev/null || stat -f%z img/top-langs-light.svg) -lt 2500 ]; then
                    echo "top-langs-light.svg is too small, reverting changes..."
                    git checkout HEAD -- img/top-langs-light.svg 2>/dev/null || rm -f img/top-langs-light.svg
                  fi
                else
                  echo "Failed to download top-langs-light.svg, removing file..."
                  git checkout HEAD -- img/top-langs-light.svg 2>/dev/null || rm -f img/top-langs-light.svg
                fi
                
                if wget -O img/top-langs.svg "https://github-readme-stats.vercel.app/api/top-langs?username=stn1slv&show_icons=true&locale=en&layout=compact&hide=markdown,xml,html,asciidoc,handlebars&langs_count=8&no-bg=true"; then
                  # Check file size and revert if too small
                  if [ $(stat -c%s img/top-langs.svg 2>/dev/null || stat -f%z img/top-langs.svg) -lt 2500 ]; then
                    echo "top-langs.svg is too small, reverting changes..."
                    git checkout HEAD -- img/top-langs.svg 2>/dev/null || rm -f img/top-langs.svg
                  fi
                else
                  echo "Failed to download top-langs.svg, removing file..."
                  git checkout HEAD -- img/top-langs.svg 2>/dev/null || rm -f img/top-langs.svg
                fi
      # - name: Update Contributor stat
      #   run: |
      #         wget -O img/github-contributor-dark.svg "https://github-contributor-stats.vercel.app/api?username=stn1slv&limit=10&theme=vue-dark&combine_all_yearly_contributions=true&hide_title=false&hide_border=true&locale=en&custom_title=GitHub%20Contributions"
      #         wget -O img/github-contributor-light.svg "https://github-contributor-stats.vercel.app/api?username=stn1slv&limit=10&theme=vue&combine_all_yearly_contributions=true&hide_title=false&hide_border=true&locale=en&custom_title=GitHub%20Contributions"
      - name: Commit report
        run: |
          git status
          git add img/*.svg || echo "No SVG files to stage"
          git commit -m "Stats refreshed" || echo "No changes to commit"
          git push origin main
